<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>각인 시뮬레이터</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      font-family: 'Malgun Gothic', sans-serif;
    }
    .background {
      background-image: url('background.png'); /* 배경 이미지 */
      background-size: cover;
      width: 663px;
      height: 501px;
      position: relative;
      margin: 20px auto;
      box-shadow: 0 0 15px #000;
    }

    .slot {
      position: absolute;
      left: 17px;
      width: 170px;
      height: 45px;
      display: flex;
      align-items: center;
      background: rgba(0, 0, 0, 0.45);
      border: 2px solid transparent;
      border-radius: 6px;
      padding: 3px 10px;
      color: #ffff00;
      font-size: 12px;
      cursor: pointer;
    }

    .slot img {
      width: 48px;
      height: 48px;
      margin-right: 10px;
    }

    .slot:hover {
      background: rgba(255,255,255,0.1);
    }

    .gold  { border-color: #d8b133; }
    .red   { border-color: #db5a29; }
    .white { border-color: #ccc; }
    .blue  { border-color: #2c74c4; }
    .green { border-color: #4caf50; }

    .slot:nth-child(1) { top: 170px; } /* 황룡 */
    .slot:nth-child(2) { top: 232px; } /* 주작 */
    .slot:nth-child(3) { top: 290px; } /* 백호 */
    .slot:nth-child(4) { top: 345px; } /* 청룡 */
    .slot:nth-child(5) { top: 400px; } /* 현무 */

    .engraving-buttons {
      position: absolute;
      right: 10px;
      top: 150px;
      width: 390px;
    }

    .engraving-buttons button {
      margin: 4px;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      background: #333;
      color: white;
      font-size: 12px;
      cursor: pointer;
    }

    .engraving-buttons button:hover {
      background: #555;
    }

    .log {
      margin-top: 8px;
      background: rgba(0,0,0,0.5);
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #333;
      font-size: 12px;
      color: #fff;
    }
    
    .tab-buttons {
      position: absolute;
      top: -110px;
      left: 0px;
    }

    .tab-buttons button {
      margin: 2px;
      padding: 6px 10px;
      font-size: 12px;
      background: #222;
      color: white;
      border: 1px solid #555;
      border-radius: 4px;
      cursor: pointer;
    }

    .tab-buttons button.active {
      background: #666;
      font-weight: bold;
    }

    label {
      display: block;
      margin: 4px 0;
    }

    label input {
      float: right;
      width: 120px;
      text-align: right;
      margin-left: 10px;
    }

    #customImage {
      position: absolute;
      left: 475px;
      top: 210px;
      width: 120px;
      height: auto;
      z-index: 10;
      pointer-events: none; /* 클릭 막기 */
    }

    .stat-tabs {
      width: 663px;
      margin: 8px auto 0;
      text-align: center;
    }
    .stat-tabs button {
      margin: 2px;
      padding: 6px 12px;
      background: #222;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .stat-tabs button.active {
      background: #5caeff;
      font-weight: bold;
    }

    .stat-type-btn {
      background: #333;
      color: #fff;
      border: 1px solid #777;
      padding: 6px 10px;
      margin: 2px;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
    }

    .stat-type-btn.selected {
      background: #ffcc66;
      color: #000;
      font-weight: bold;
    }

    .main-btn {
    margin: 4px 6px;
    padding: 6px 16px;
    font-size: 13px;
    background: #222;
    color: #8cffe6;
    border: 1px solid #444;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.2s, transform 0.1s;
  }

  .main-btn:hover {
    background: #333;
    transform: translateY(-1px);
  }

  .reset-btn {
  display: inline-block;
  margin: 4px 6px;
  background: linear-gradient(to right, #222, #444);
  border: 1px solid #666;
  border-radius: 6px;
  color: #ffcc66;
  font-weight: bold;
  font-size: 12px;
  padding: 6px 12px;
  min-width: 100px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.reset-btn:hover {
  background: linear-gradient(to right, #444, #666);
  color: #fff5cc;
  transform: translateY(-1px);
}

            
  </style>
</head>
<body>

<!-- 🔥 인삿말 배너 -->
<div id="greetingBanner" style="
  width: 663px;
  margin: 10px auto 4px;
  padding: 10px;
  background: linear-gradient(to right, #1a1a1a, #333);
  color: #ffcc66;
  font-size: 14px;
  font-weight: bold;
  text-align: center;
  border-radius: 6px;
  box-shadow: 0 0 5px #000;
  border: 1px solid #555;
">
  🛠️ 현명한 대장장이들의 스택쌓는곳 🛠️ 만든사람 : 전쿠린@연 <br>
</div>

<!-- 🔘 기능 버튼 -->
<div id="mainNavButtons" style="
  width: 663px;
  margin: 6px auto 12px;
  text-align: center;
">
  <button class="main-btn">각인</button>
  <button class="main-btn">황금돋보기</button>
  <button class="main-btn">기술특화</button>
  <button class="main-btn">사행성</button>
  <button class="main-btn">계산기</button>
</div>

<!-- 🔥 상단 소지금 표시 영역 -->
<div id="goldStatus" class="log" style="
width: 663px;
margin: 8px auto;
background: rgba(0,0,0,0.7);
font-size: 13px;
font-weight: bold;
color: #ffffcc;
text-align: center;
border: 1px solid #555;
border-radius: 6px;
padding: 6px;
white-space: pre-line;
"></div>

<!-- ✅ 총 스탯 수치 표시 영역 (JS에서 동적으로 삽입) -->
<div id="totalPenetrationDisplay" style="
  width: 663px;
  margin: 8px auto;
  background: rgba(0, 0, 0, 0.7);
  font-size: 13px;
  font-weight: bold;
  color: #ccffcc;
  text-align: center;
  border: 1px solid #555;
  border-radius: 6px;
  padding: 6px;
">
  총 스탯 수치: 계산중...
</div>

<!-- 🔘 스탯 선택 탭 -->
<div class="stat-tabs" id="statTabContainer">
</div>

<!-- 🎯 스탯 선택 탭
<div id="statTypeSelector" style="
  width: 663px;
  margin: 0 auto 8px;
  text-align: center;
">
  <button onclick="selectStatType('방어구관통')" class="stat-type-btn selected">방어구관통</button>
  <button onclick="selectStatType('방어도무시')" class="stat-type-btn">방어도무시</button>
  <button onclick="selectStatType('방어도')" class="stat-type-btn">방어도</button>
  <button onclick="selectStatType('직타저항')" class="stat-type-btn">직타저항</button>
  <button onclick="selectStatType('피해흡수')" class="stat-type-btn">피해흡수</button>
  <button onclick="selectStatType('피해흡수무시')" class="stat-type-btn">피해흡수무시</button>
</div> -->

<!-- 💸 가격 설정 토글 버튼 -->
<div style="width: 663px; margin: 0 auto; text-align: center;">
  <button id="priceToggle" onclick="togglePriceConfig()" style="
    background: #444;
    color: #fff;
    padding: 6px 12px;
    border: 1px solid #888;
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    margin-top: 8px;
  ">💸 비서 가격 설정 펼치기</button>
</div>

<div id="priceConfig" style="
  display: none;
  width: 663px;
  margin: 8px auto 12px;
  background: rgba(255,255,255,0.05);
  padding: 14px 20px;
  border: 1px solid #666;
  border-radius: 8px;
  color: #fff;
  font-size: 13px;
  box-shadow: 0 0 6px #000;
">
  <div style="display: flex;">
    <!-- 왼쪽 컬럼 -->
    <div style="flex: 1; padding-right: 20px; border-right: 1px solid #555;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span>🛡️ 신 앞각</span>
        <input type="text" id="priceFlat신" value="3600000" oninput="formatWithComma(this)" style="width: 100px; text-align: right;">
      </div>
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span>🛡️ 보물 앞각</span>
        <input type="text" id="priceFlat보물" value="6000000" oninput="formatWithComma(this)" style="width: 100px; text-align: right;">
      </div>
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span>🛡️ 전설 앞각</span>
        <input type="text" id="priceFlat전설" value="25000000" oninput="formatWithComma(this)" style="width: 100px; text-align: right;">
      </div>
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span>⚔️ 도깨비 뒷각</span>
        <input type="text" id="priceAdd도깨비" value="6400000" oninput="formatWithComma(this)" style="width: 100px; text-align: right;">
      </div>
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span>⚔️ 보물 뒷각</span>
        <input type="text" id="priceAdd보물" value="18000000" oninput="formatWithComma(this)" style="width: 100px; text-align: right;">
      </div>
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span>⚔️ 전설 뒷각</span>
        <input type="text" id="priceAdd전설" value="35000000" oninput="formatWithComma(this)" style="width: 100px; text-align: right;">
      </div>
    </div>

    <!-- 오른쪽 컬럼 -->
    <div style="flex: 1; padding-left: 20px;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span>🐉 신수 고급추각 1.8%</span>
        <input type="text" id="priceAdd[신수]1.8" value="4600000" oninput="formatWithComma(this)" style="width: 100px; text-align: right;">
      </div>
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span>🐉 신수 고급추각 1.5%</span>
        <input type="text" id="priceAdd[신수]1.5" value="6000000" oninput="formatWithComma(this)" style="width: 100px; text-align: right;">
      </div>
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span>🐉 신수 고급추각 1.0%</span>
        <input type="text" id="priceAdd[신수]1.0" value="3500000" oninput="formatWithComma(this)" style="width: 100px; text-align: right;">
      </div>
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span>🐲 황룡 일반</span>
        <input type="text" id="priceHwang일반" value="80000000" oninput="formatWithComma(this)" style="width: 100px; text-align: right;">
      </div>
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span>🐲 황룡 희귀</span>
        <input type="text" id="priceHwang희귀" value="15000000" oninput="formatWithComma(this)" style="width: 100px; text-align: right;">
      </div>
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span>✨ 초월각인비서</span>
        <input type="text" id="priceTranscend" value="700000000" oninput="formatWithComma(this)" style="width: 100px; text-align: right;">
      </div>
    </div>
  </div>

  <!-- 버튼 영역 -->
  <div style="text-align: center; margin-top: 14px;">
    <button onclick="applyNewPrices()" style="
      background: #2c74c4;
      color: #fff;
      padding: 6px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    ">💾 가격 반영</button>
  </div>
</div>


<!-- <img src="kurin.png" id="customImage"> -->
<div class="background">
  <div class="slot gold" onclick="selectSlot(0)">
    <img src="hwangryong.png" alt="황룡">
    <span id="text0">봉인된 문양</span>
  </div>
  <div class="slot red" onclick="selectSlot(1)">
    <img src="juzak.png" alt="주작">
    <span id="text1">봉인된 문양</span>
  </div>
  <div class="slot white" onclick="selectSlot(2)">
    <img src="baekho.png" alt="백호">
    <span id="text2">봉인된 문양</span>
  </div>
  <div class="slot blue" onclick="selectSlot(3)">
    <img src="cheongryong.png" alt="청룡">
    <span id="text3">봉인된 문양</span>
  </div>
  <div class="slot green" onclick="selectSlot(4)">
    <img src="hyeonmu.png" alt="현무">
    <span id="text4">봉인된 문양</span>
  </div>

  <!-- 각인 버튼 -->
  <div class="engraving-buttons">
    <!-- ✅ 이건 남겨야 함 -->
    <div class="tab-buttons">
      <button onclick="switchTab('flat')">앞각</button>
      <button onclick="switchTab('add')">뒷각</button>
      <button onclick="switchTab('hwangryong')">황룡</button>
      <button onclick="switchTab('transcend')">초월</button>
    </div>

    <!-- 앞각 -->
    <div id="tab-flat" class="engraving-tab">
      <button onclick="applyFlat('신')">도깨비방어구관통'신</button>
      <button onclick="applyFlat('보물')">보물도깨비방어구관통</button>
      <button onclick="applyFlat('전설')">전설도깨비방어구관통</button>
    </div>

    <!-- 뒷각 -->
    <div id="tab-add" class="engraving-tab" style="display:none;">
      <!-- 신수 뒷각 추가 -->
      <!-- <button onclick="applyAdd('[신수]1.8')">[신수]고급방어구관통추가각인비서(+1.8%)</button>
      <button onclick="applyAdd('[신수]1.5')">[신수]고급방어구관통추가각인비서(+1.5%)</button>
      <button onclick="applyAdd('[신수]1.0')">[신수]고급방어구관통추가각인비서(+1.0%)</button> -->
      <button onclick="applyAdd('도깨비')">도깨비추가각인비서</button>
      <button onclick="applyAdd('보물')">보물도깨비추가각인비서</button>
      <button onclick="applyAdd('전설')">전설도깨비추가각인비서</button>
    </div>

    <!-- 황룡 -->
    <div id="tab-hwangryong" class="engraving-tab" style="display:none;">
      <button onclick="applyHwangryongCopy('일반')">[황룡] 잠재력각인비서</button>
      <button onclick="applyHwangryongCopy('희귀')">[황룡] 희귀잠재력각인비서</button>
    </div>

    <!-- 초월 -->
    <div id="tab-transcend" class="engraving-tab" style="display:none;">
      <button onclick="applyTranscend()">초월각인비서 사용</button>
    </div>

    <div class="log" id="log">슬롯을 선택한 후 비서를 사용하세요.</div>
    <div class="log" id="usageSummary" style="margin-top:4px;"></div>

  </div>
</div>

<!-- 이펙트 표시용 이미지 (처음엔 안보임) -->
<img id="effectImage" src="" style="position: absolute; left: 230px; top: 100px; width: 180px; display: none; pointer-events: none; z-index: 999;">

<!-- 🔄 초기화 버튼들 (중앙 정렬, 좁은 가로폭) -->
<div style="margin-top: 12px; text-align: center;">
  <button class="reset-btn" onclick="resetSelectedEngraving()">🧹 선택 초기화</button>
  <button class="reset-btn" onclick="resetAllEngravings()">🧼 전체 초기화</button>
</div>

<!-- 사용량 요약 테이블 표시 -->
<div id="usageTable" style="
  margin: 8px auto; 
  width: 663px;
  background: rgba(0, 0, 0, 0.7);
  color: #fff;
  padding: 10px;
  border: 1px solid #444;
  border-radius: 6px;
  font-size: 12px;
  white-space: pre-line;
"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<button id="kakaoShareBtn" style="
background: #fae100;
color: #000;
padding: 6px 12px;
border: none;
border-radius: 6px;
font-weight: bold;
cursor: pointer;
margin: 6px auto;
display: block;
">💬 각인 자랑하기 (미지원)</button>

<script>
  const totalAddUsage = {
    "도깨비": 0,
    "보물": 0,
    "전설": 0,
    "[신수]1.8": 0,
    "[신수]1.5": 0,
    "[신수]1.0": 0
  };

    const slotAddUsage = Array.from({ length: 5 }, () => ({
    "도깨비": 0,
    "보물": 0,
    "전설": 0,
    "[신수]1.8": 0,
    "[신수]1.5": 0,
    "[신수]1.0": 0
  }));


  const slotNames = ["황룡", "주작", "백호", "청룡", "현무"];
  const slotStates = Array.from({ length: 5 }, () => ({ flat: null }));
  let selectedSlot = null;

  function selectSlot(index) {
    document.querySelectorAll('.slot').forEach(el => el.classList.remove('selected'));
    selectedSlot = index;
    document.querySelectorAll('.slot')[index].classList.add('selected');
    updateLog(`${slotNames[index]} 슬롯 선택됨`);
  }

  const totalUsage = {
  "신": 0,
  "보물": 0,
  "전설": 0
  };

  const slotUsage = Array.from({ length: 5 }, () => ({
    "신": 0,
    "보물": 0,
    "전설": 0
  }));
  
  const hwangryongUsage = {
  "일반": 0,
  "희귀": 0
};

const hwangryongSlotUsage = {
  "일반": 0,
  "희귀": 0
};


function switchTab(tab) {
  // 모든 탭 숨기기
  document.querySelectorAll('.engraving-tab').forEach(div => div.style.display = 'none');

  // 모든 버튼 비활성화
  document.querySelectorAll('.tab-buttons button').forEach(btn => btn.classList.remove('active'));

  // 선택한 탭 보이기
  document.getElementById(`tab-${tab}`).style.display = 'block';

  // 선택한 버튼 활성화
  const idx = {flat: 0, add: 1, hwangryong: 2, transcend: 3}[tab];
  document.querySelectorAll('.tab-buttons button')[idx].classList.add('active');
}



  function roundToOneDecimal(value) {
  return Math.round(value * 10) / 10;
}

function applyFlatUnified(tier) {
  if (selectedSlot === null) return updateLog("먼저 슬롯을 선택하세요.");
  if (selectedSlot === 0) return updateLog("황룡 슬롯에는 사용할 수 없습니다.");

  const state = slotStates[selectedSlot];

  if (state.add !== undefined) return updateLog("뒷각이 이미 있어 앞각 변경이 불가합니다.");

  const config = STAT_CONFIG[currentStat].flat[tier];
  const maxValue = Math.max(...config.values);

  if (state.statType === currentStat && state.flat === maxValue) {
    return updateLog(`🛡️ 이미 ${tier} ${currentStat} 최대치(${maxValue}%)가 각인되어 있습니다.`);
  }

  const rand = Math.random() * 100;
  let sum = 0;
  let result = config.values[config.values.length - 1];

  for (let i = 0; i < config.values.length; i++) {
    sum += config.probs[i];
    if (rand <= sum) {
      result = config.values[i];
      break;
    }
  }

  if (!spend(priceTable.flat[tier])) return;

  state.flat = result;
  state.statType = currentStat;

  // ✅ 앞각 사용량 기록
  totalUsage[tier]++;
  slotUsage[selectedSlot][tier]++;

  updateSlotDisplay(selectedSlot);
  updateLog(`✅ ${slotNames[selectedSlot]} 슬롯에 ${tier} ${currentStat} 앞각 +${result}% 적용됨`);
  updateUsageSummary();
  showEffect("flat");
  updateTotalStatUI();
}


function applyAdd(type) {
  if (selectedSlot === null) return updateLog("먼저 슬롯을 선택하세요.");
  if (selectedSlot === 0) return updateLog("황룡 슬롯에는 뒷각을 사용할 수 없습니다.");

  const state = slotStates[selectedSlot];
  if (state.flat === null) return updateLog("앞각이 없는 슬롯에는 뒷각을 사용할 수 없습니다.");

  const currentAdd = state.add ?? 0;

  // ✅ 최대치 제한: 앞각의 50% 이상이면 불가
  if (state.add !== undefined && currentAdd >= state.flat * 0.45) {
    return updateLog("⚠️ 뒷각 수치가 이미 앞각의 50% 이상입니다. 더 이상 각인할 수 없습니다.");
  }

  // ✅ 신수 비서는 1.8 이상이면 제한
  if (["[신수]1.8", "[신수]1.5", "[신수]1.0"].includes(type) && currentAdd >= 1.8) {
    return updateLog("이미 최대 수치의 뒷각이 각인되어 있어 신수추각 비서를 사용할 수 없습니다.");
  }

  if (currentAdd >= 1.90) return updateLog("뒷각 수치가 최대입니다. 더 이상 각인할 수 없습니다.");

  let addValue = null;
  let success = true;

  if (["[신수]1.8", "[신수]1.5", "[신수]1.0"].includes(type)) {
    if (!spend(priceTable.add[type])) return;

    const successRate = {
      "[신수]1.8": 0.01,
      "[신수]1.5": 0.05,
      "[신수]1.0": 0.10
    }[type];

    success = Math.random() < successRate;
    addValue = parseFloat(type.match(/\d\.\d/)[0]);

    totalAddUsage[type] = (totalAddUsage[type] || 0) + 1;
    slotAddUsage[selectedSlot][type] = (slotAddUsage[selectedSlot][type] || 0) + 1;

    if (!success) {
      updateLog(`❌ ${slotNames[selectedSlot]} 슬롯에 ${type} 실패!`);
      updateUsageSummary();
      return;
    }
  } else {
    if (!spend(priceTable.add[type])) return;
    addValue = getAddValue(type, state.flat);
    totalAddUsage[type]++;
    slotAddUsage[selectedSlot][type]++;
  }

  state.add = addValue;
  updateSlotDisplay(selectedSlot);
  updateLog(`✅ ${slotNames[selectedSlot]} 슬롯에 ${type} 성공! 뒷각 +${addValue}% 적용됨`);
  updateUsageSummary();
  showEffect("add");
  updateTotalStatUI();
}




  function clearEngraving() {
    if (selectedSlot === null) return updateLog("먼저 슬롯을 선택하세요.");

    slotStates[selectedSlot].flat = null;
    updateSlotDisplay(selectedSlot);
    updateLog(`${slotNames[selectedSlot]} 슬롯의 각인이 제거되었습니다.`);
  }

  function getTranscendAddColor(level) {
  if (level === 3) return '#d0a9f5';  // 연보라
  if (level === 2) return '#ff6a00';  // 찐주황
  if (level === 1) return '#e0b84a';  // 황토+노랑
  return '#ffffff';
}

// const STAT_CONFIG = {
//   방어구관통: { displayName: "방어구관통", color: "#ffff00" },
//   방어도무시: { displayName: "방어도무시", color: "#ff9999" },
//   방어도: { displayName: "방어도", color: "#99ccff" },
//   피해흡수: { displayName: "피해흡수", color: "#ccffcc" },
//   피해흡수무시: { displayName: "피해흡수무시", color: "#ffcc99" },
//   공격력증가: { displayName: "공격력증가", color: "#ffcc00" },
//   직타저항: { displayName: "직타저항", color: "#ddaaff" },
//   마력증강: { displayName: "마력증강", color: "#aaaaff" },
// };


function updateSlotDisplay(index) {
  const state = slotStates[index];
  const textEl = document.getElementById(`text${index}`);

  if (!state || !state.statType) {
    textEl.innerText = `　　　봉인된 문양`;
    return;
  }

  const isFlat1 = state.statType === "방어구관통";
  const flat = state.flat?.toFixed(isFlat1 ? 1 : 2);
  const add = state.add?.toFixed(isFlat1 ? 1 : 2);
  const transcend = state.transcendLevel || 0;

  const defaultColor = "#ffff00";

  let html = `　　${state.statType}<br><span style="color:${defaultColor}">+${flat}%[x]</span>`;

  if (add !== undefined && add !== null) {
    const addColor = transcend > 0 ? getTranscendAddColor(transcend) : defaultColor;
    html += ` <span style="color:${addColor}">+${add}%[x]</span>`;
  }

  if (transcend > 0) {
    html += `<br><span style="color:#ffffff">(　초월강화 +${transcend}강　)</span>`;
  }

  textEl.innerHTML = html;
}





function showEffect(type) {
  const effect = document.createElement('img');
  effect.src = `effects/effect_${type}.gif`; // flat, add, transcend 중 하나
  effect.className = 'effect-gif';
  
  // 슬롯 위치 중앙에 맞추기
  const slot = document.querySelectorAll('.slot')[selectedSlot];
  const rect = slot.getBoundingClientRect();

  effect.style.position = 'absolute';
  effect.style.left = `${rect.left + rect.width / 2}px`;
  effect.style.top = `${rect.top + rect.height / 2}px`;
  effect.style.transform = 'translate(-50%, -50%)';
  effect.style.pointerEvents = 'none';
  effect.style.zIndex = '999';

  document.body.appendChild(effect);

  setTimeout(() => {
    effect.remove();
  }, 800); // 자동 제거
}


  function updateLog(msg) {
    document.getElementById("log").innerText = msg;
  }

  function updateUsageSummary() {
  let html = `<b>📦 총 사용량</b><br>`;
  html += `<ul style="margin-top:4px; padding-left:18px;">`;
  html += `<li>앞각 - 신: ${totalUsage["신"]}장, 보물: ${totalUsage["보물"]}장, 전설: ${totalUsage["전설"]}장</li>`;
  html += `<li>뒷각 - 도깨비: ${totalAddUsage["도깨비"]}장, 보물: ${totalAddUsage["보물"]}장, 전설: ${totalAddUsage["전설"]}장</li>`;
  html += `<li>뒷각 - [신수]1.8%: ${totalAddUsage["[신수]1.8"]}장, 1.5%: ${totalAddUsage["[신수]1.5"]}장, 1.0%: ${totalAddUsage["[신수]1.0"]}장</li>`;
  html += `<li>황룡 - 일반: ${hwangryongUsage["일반"]}장, 희귀: ${hwangryongUsage["희귀"]}장</li>`;
  html += `</ul>`;

  html += `<b>📌 슬롯별 사용량</b><br>`;
  html += `<table style="width:100%; border-collapse: collapse; margin-top: 5px;">`;
  html += `<thead><tr style="background:#222;"><th style="padding:2px;">슬롯</th><th>앞각</th><th>뒷각</th><th>황룡</th></tr></thead>`;
  html += `<tbody>`;

  for (let i = 0; i < 5; i++) {
    const name = slotNames[i];
    const flatStr = Object.entries(slotUsage[i]).filter(([_, v]) => v > 0)
        .map(([k, v]) => `'${k}': ${v}장`).join(', ') || '-';

        const addStr = Object.entries(slotAddUsage[i]).filter(([_, v]) => v > 0)
        .map(([k, v]) => `${k}: ${v}장`).join(', ') || '-';

    const hwangStr = (i === 0)
      ? Object.entries(hwangryongSlotUsage).filter(([_, v]) => v > 0)
        .map(([k, v]) => `${k}: ${v}장`).join(', ') || '-'
      : '-';

    html += `<tr style="text-align:center;"><td>${name}</td><td>${flatStr}</td><td>${addStr}</td><td>${hwangStr}</td></tr>`;
  }

  html += `</tbody></table>`;

  document.getElementById("usageTable").innerHTML = html;
}

function applyHwangryongCopy(type) {
  if (selectedSlot !== 0) return updateLog("황룡 슬롯에서만 사용할 수 있습니다.");

  const state = slotStates[0];
  if (state.flat !== null) {
    return updateLog("황룡 슬롯에 이미 잠재력이 각인되어 있습니다.");
  }

  // ✅ 여기에서 주작~현무 슬롯에 앞각(flat)이 모두 존재하는지 검사
  const requiredSlots = [1, 2, 3, 4];
  const allReady = requiredSlots.every(i => slotStates[i].flat != null);
  if (!allReady) {
    return updateLog("🛑 주작, 백호, 청룡, 현무 모두에 앞각이 있어야 황룡에 복사할 수 있습니다.");
  }

  // 💸 비용 차감 먼저
  if (!spend(priceTable.hwangryong[type])) return;

  const successRate = type === '희귀' ? 5 : 3;
  const success = Math.random() * 100 < successRate;

  hwangryongUsage[type]++;
  hwangryongSlotUsage[type]++;

  updateUsageSummary();

  if (!success) {
    updateLog(`[황룡] ${type}잠재력각인비서 실패!`);
    return;
  }

  const candidates = [1, 2, 3, 4]; // 주작~현무
  const chosen = candidates[Math.floor(Math.random() * candidates.length)];
  const source = slotStates[chosen];

  if (!source.flat) {
    updateLog(`[황룡] 선택된 슬롯(${slotNames[chosen]})에 앞각이 없어 복사 실패`);
    return;
  }

  slotStates[0].flat = source.flat;
  slotStates[0].add = source.add ?? undefined;
  slotStates[0].statType = source.statType;

  updateSlotDisplay(0);
  updateLog(`[황룡] ${type}잠재력각인비서 성공! ${slotNames[chosen]}의 각인을 복사했습니다.`);
  updateTotalStatUI();
}



function applyTranscend() {
  if (selectedSlot === null) return updateLog("슬롯을 먼저 선택하세요.");
  const state = slotStates[selectedSlot];

  if (!state.flat || !state.add) return updateLog("앞각과 뒷각이 모두 있어야 초월강화가 가능합니다.");
  if (slotStates[0].flat === null) return updateLog("황룡 슬롯에 각인이 있어야 초월강화를 사용할 수 있습니다.");

  if (!state.transcendLevel) state.transcendLevel = 0;
  if (state.transcendLevel >= 3) return updateLog("초월강화는 슬롯당 최대 3강까지 가능합니다.");

  if (!spend(priceTable.transcend)) return;

  const chances = [
    { rate: 60, ratio: 0.10 },
    { rate: 20, ratio: 0.20 },
    { rate: 12, ratio: 0.30 },
    { rate: 6,  ratio: 0.40 },
    { rate: 2,  ratio: 0.50 }
  ];

  const rand = Math.random() * 100;
  let sum = 0;
  let chosen = chances[chances.length - 1];
  for (let i = 0; i < chances.length; i++) {
    sum += chances[i].rate;
    if (rand <= sum) {
      chosen = chances[i];
      break;
    }
  }

  let increment = state.flat * chosen.ratio;
  increment = increment < 0.01 ? 0.01 : Math.round(increment * 100) / 100;

  state.add += increment;
  state.transcendLevel++;

  updateSlotDisplay(selectedSlot);
  updateLog(`${slotNames[selectedSlot]} 슬롯 초월강화 +${state.transcendLevel}강 성공! (앞각의 ${Math.round(chosen.ratio * 100)}%인 +${increment.toFixed(2)}% 누적됨)`);
  updateUsageSummary();
  showEffect("transcend");
  updateTotalStatUI();
}





  function getFlatValue(type) {
  const table = {
    "신": [
      { p: 68.00, v: 0.70 },
      { p: 21.00, v: 1.70 },
      { p: 8.00, v: 2.80 },
      { p: 3.00, v: 3.70 },
    ],
    "보물": [
      { p: 55.00, v: 0.70 },
      { p: 24.00, v: 1.50 },
      { p: 12.00, v: 2.20 },
      { p: 7.00,  v: 3.00 },
      { p: 2.00,  v: 3.80 },
    ],
    "전설": [
      { p: 40.00, v: 0.90 },
      { p: 29.00, v: 1.70 },
      { p: 20.00, v: 2.40 },
      { p: 9.50,  v: 3.20 },
      { p: 1.50,  v: 4.00 },
    ]
  };

  const rand = Math.random() * 100;
  let sum = 0;
  for (let i = 0; i < table[type].length; i++) {
    sum += table[type][i].p;
    if (rand <= sum) return table[type][i].v; // 숫자 그대로 반환!!!
  }
  return table[type][table[type].length - 1].v;
}


function getAddValue(type, flatValue) {
  const table = {
    "전설": [
      { rate: 40.0, ratio: 0.10 },
      { rate: 40.0, ratio: 0.20 },
      { rate: 15.0, ratio: 0.25 },
      { rate: 5.0,  ratio: 0.50 },
    ],
    "보물": [
      { rate: 60.0, ratio: 0.10 },
      { rate: 30.0, ratio: 0.20 },
      { rate: 7.0,  ratio: 0.25 },
      { rate: 3.0,  ratio: 0.50 },
    ],
    "도깨비": [
      { rate: 80.0, ratio: 0.10 },
      { rate: 15.0, ratio: 0.20 },
      { rate: 4.0,  ratio: 0.25 },
      { rate: 1.0,  ratio: 0.50 },
    ]
  };

  const baseUnit = {
    "방어도무시": 0.32,
    "방어도": 0.32,
    "공격력증가": 0.08,
    "피해흡수": 0.08,
    "마력증강": 0.08,
    "직타저항": 0.08,
    "피해흡수무시": 0.06
  };

  const list = table[type];
  const rand = Math.random() * 100;
  let sum = 0;
  let chosenRatio = list[list.length - 1].ratio;

  for (let i = 0; i < list.length; i++) {
    sum += list[i].rate;
    if (rand <= sum) {
      chosenRatio = list[i].ratio;
      break;
    }
  }

  if (currentStat === "방어구관통") {
    return roundToOneDecimal(flatValue * chosenRatio); // 기존 방식
  }

  const unit = baseUnit[currentStat];
  if (!unit) return roundToOneDecimal(flatValue * chosenRatio); // fallback

  const result = Math.round((flatValue / unit) * chosenRatio) * unit;
  return result
}



// 초기 소지금
let gold = 50000000000; // 500억 전
const initialGold = gold;

const priceTable = {
  flat: { "신": 3600000, "보물": 6000000, "전설": 25000000 },
  add:  { "도깨비": 6400000, "보물": 18000000, "전설": 35000000,
    "[신수]1.8": 4600000,
    "[신수]1.5": 6000000,
    "[신수]1.0": 3500000 },
  hwangryong: { "일반": 80000000, "희귀": 150000000 },
  transcend: 700000000
};

// 💸 소지금 차감 함수
function spend(amount) {
  if (gold < amount) {
    updateLog("💸 소지금이 부족합니다!");
    return false;
  }
  gold -= amount;
  updateGoldUI();
  return true;
}

// 💸 상단 소지금 표시 갱신
function updateGoldUI() {
  const used = initialGold - gold;
  const cash = Math.round((used / 100000000) * 45000);
  document.getElementById("goldStatus").innerText =
    `💰 사용 금전: ${used.toLocaleString()}전 | 💴 환산: 약 ${cash.toLocaleString()}원 | 남은 금전: ${gold.toLocaleString()}전`;
}

function togglePriceConfig() {
  const div = document.getElementById('priceConfig');
  const btn = document.getElementById('priceToggle');
  if (div.style.display === 'none') {
    div.style.display = 'block';
    btn.innerText = '💸 비서 가격 설정 접기';
  } else {
    div.style.display = 'none';
    btn.innerText = '💸 비서 가격 설정 펼치기';
  }
}

function applyNewPrices() {
  priceTable.flat["신"] = +document.getElementById("priceFlat신").value.replace(/,/g, '');
  priceTable.flat["보물"] = +document.getElementById("priceFlat보물").value.replace(/,/g, '');
  priceTable.flat["전설"] = +document.getElementById("priceFlat전설").value.replace(/,/g, '');
  priceTable.add["도깨비"] = +document.getElementById("priceAdd도깨비").value.replace(/,/g, '');
  priceTable.add["보물"] = +document.getElementById("priceAdd보물").value.replace(/,/g, '');
  priceTable.add["전설"] = +document.getElementById("priceAdd전설").value.replace(/,/g, '');
  priceTable.add["[신수]1.8"] = +document.getElementById("priceAdd[신수]1.8").value.replace(/,/g, '');
  priceTable.add["[신수]1.5"] = +document.getElementById("priceAdd[신수]1.5").value.replace(/,/g, '');
  priceTable.add["[신수]1.0"] = +document.getElementById("priceAdd[신수]1.0").value.replace(/,/g, '');
  priceTable.hwangryong["일반"] = +document.getElementById("priceHwang일반").value.replace(/,/g, '');
  priceTable.hwangryong["희귀"] = +document.getElementById("priceHwang희귀").value.replace(/,/g, '');
  priceTable.transcend = +document.getElementById("priceTranscend").value.replace(/,/g, '');
  alert("💰 가격이 성공적으로 반영되었습니다!");
}

function togglePricePanel() {
  const panel = document.getElementById('pricePanel');
  panel.style.display = (panel.style.display === 'none') ? 'block' : 'none';
}

function formatWithComma(input) {
  const value = input.value.replace(/,/g, '');
  if (isNaN(value)) return;
  input.value = Number(value).toLocaleString();
}

document.getElementById("kakaoShareBtn").addEventListener("click", async () => {
  const target = document.body; // 전체 UI 캡처
  try {
    const canvas = await html2canvas(target, {
      useCORS: true,
      width: 663,
      height: 750, // 여유 있게 설정
      scale: window.devicePixelRatio || 1
    });

    canvas.toBlob(async (blob) => {
      if (!navigator.clipboard) {
        alert("클립보드 복사가 지원되지 않는 브라우저입니다.");
        return;
      }

      await navigator.clipboard.write([
        new ClipboardItem({ [blob.type]: blob })
      ]);

      alert("📸 이미지가 클립보드에 복사되었습니다!\n카카오톡에 붙여넣기 하세요!");

      const message = `🛡️⚔️ 방관 ${calculateTotalStat()}각인을 만들었어요!\n` +
        "https://ekdms05.github.io/Engraving-Simulator/\n각인시뮬레이터 - 전쿠린@연";
      await navigator.clipboard.writeText(message);
    });

  } catch (e) {
    alert("스크린샷 생성에 실패했습니다.");
    console.error(e);
  }
});

const STAT_CONFIG = {
  "방어도무시": {
    flat: {
      신: { values: [0.32, 0.64, 0.96, 1.92], probs: [68, 21, 8, 3] },
      보물: { values: [0.32, 0.64, 0.96, 1.60, 2.24], probs: [55, 24, 12, 7, 2] },
      전설: { values: [0.64, 0.96, 1.28, 1.92, 2.56], probs: [40, 29, 20, 9.5, 1.5] }
    },
    displayName: "방어도무시",
    color: "#ffdd66"
  },
  "방어구관통": {
    flat: {
      신: { values: [0.70, 1.70, 2.80, 3.70], probs: [68, 21, 8, 3] },
      보물: { values: [0.70, 1.50, 2.20, 3.00, 3.80], probs: [55, 24, 12, 7, 2] },
      전설: { values: [0.90, 1.70, 2.40, 3.20, 4.00], probs: [40, 29, 20, 9.5, 1.5] }
    },
    displayName: "방어구관통",
    color: "#ccffcc"
  },
  "공격력증가": {
    flat: {
      신:    { values: [0.64, 2.16, 3.36, 4.80], probs: [68, 21, 8, 3] },
      보물:  { values: [0.64, 1.20, 2.56, 3.84, 5.20], probs: [55, 24, 12, 7, 2] },
      전설:  { values: [0.88, 1.84, 2.80, 4.08, 5.44], probs: [40, 29, 20, 9.5, 1.5] }
    },
    displayName: "공격력증가",
    color: "#ffcc00"
  },
  "피해흡수": {
    flat: {
      신: { values: [0.64, 2.16, 3.36, 4.80], probs: [68, 21, 8, 3] },
      보물: { values: [0.64, 1.20, 2.56, 3.84, 5.20], probs: [55, 24, 12, 7, 2] },
      전설: { values: [0.88, 1.84, 2.80, 4.08, 5.44], probs: [40, 29, 20, 9.5, 1.5] }
    },
    displayName: "피해흡수",
    color: "#88e0ff"
  },
  "마력증강": {
    flat: {
      신:    { values: [0.56, 1.36, 2.24, 2.96], probs: [68, 21, 8, 3] },
      보물:  { values: [0.56, 1.20, 1.76, 2.40, 3.04], probs: [55, 24, 12, 7, 2] },
      전설:  { values: [0.72, 1.36, 1.92, 2.56, 3.20], probs: [40, 29, 20, 9.5, 1.5] }
    },
    displayName: "마력증강",
    color: "#aaaaff"
  },
  "방어도": {
    flat: {
      신:    { values: [0.32, 0.64, 1.28, 2.24], probs: [68, 21, 8, 3] },
      보물:  { values: [0.32, 0.64, 0.96, 1.60, 2.56], probs: [55, 24, 12, 7, 2] },
      전설:  { values: [0.64, 0.96, 1.28, 1.92, 2.88], probs: [40, 29, 20, 9.5, 1.5] }
    },
    displayName: "방어도",
    color: "#99ccff"
  },
  "직타저항": {
    flat: {
      신:    { values: [0.64, 2.16, 3.36, 4.80], probs: [68, 21, 8, 3] },
      보물:  { values: [0.64, 1.20, 2.56, 3.84, 5.20], probs: [55, 24, 12, 7, 2] },
      전설:  { values: [0.88, 1.84, 2.80, 4.08, 5.44], probs: [40, 29, 20, 9.5, 1.5] }
    },
    displayName: "직타저항",
    color: "#ddaaff"
  },
  "피해흡수무시": {
    flat: {
      신: { values: [0.66, 2.16, 3.36, 4.80], probs: [68, 21, 8, 3] },
      보물: { values: [0.66, 1.20, 2.58, 3.84, 5.16], probs: [55, 24, 12, 7, 2] },
      전설: { values: [0.90, 1.86, 2.82, 4.08, 5.40], probs: [40, 29, 20, 9.5, 1.5] }
    },
    displayName: "피해흡수무시",
    color: "#ffaacc"
  }
};

// 현재 선택된 스탯
let currentStat = "방어구관통";

function renderStatTabs() {
  const container = document.getElementById("statTabContainer");
  container.innerHTML = ""; // 초기화
  Object.keys(STAT_CONFIG).forEach(stat => {
    const btn = document.createElement("button");
    btn.innerText = STAT_CONFIG[stat].displayName;
    btn.className = stat === currentStat ? "active" : "";
    btn.onclick = () => {
      currentStat = stat;
      renderStatTabs();      // 다시 그리기
      renderFlatButtons();   // 앞각 버튼 다시 그리기
    };
    container.appendChild(btn);
  });
}

function renderFlatButtons() {
  const tab = document.getElementById("tab-flat");
  tab.innerHTML = ""; // 초기화

  ["신", "보물", "전설"].forEach(tier => {
    const btn = document.createElement("button");
    const name = `${tier} ${currentStat}`;
    btn.innerText = `${tier} ${STAT_CONFIG[currentStat].displayName} 앞각`;
    btn.onclick = () => applyFlatUnified(tier);
    tab.appendChild(btn);
  });
}

function selectStatType(stat) {
  selectedStatType = stat;

  // 버튼 UI 반영
  document.querySelectorAll('.stat-type-btn').forEach(btn => {
    btn.classList.remove('selected');
    if (btn.innerText === stat) btn.classList.add('selected');
  });

  updateLog(`📌 선택된 스탯: ${stat}`);
}

function calculateTotalStat() {
  let total = 0;
  for (const state of slotStates) {
    if (state.statType === currentStat) {
      total += (state.flat ?? 0) + (state.add ?? 0);
    }
  }
  return total;
}

function updateTotalStatUI() {
  const total = calculateTotalStat();
  const { displayName, color } = STAT_CONFIG[currentStat];
  const el = document.getElementById("totalPenetrationDisplay");
  el.innerText = `🛡️⚔️ 총 ${displayName}: ${total.toFixed(2)}%`;
  el.style.color = color; // ✅ 스탯별 색상 반영
}


function switchStatTab(stat) {
  currentStat = stat;
  renderEngravingTabs(); // 비서 버튼 재생성
  updateSlotDisplayAll(); // 슬롯 표시 업데이트
  updateTotalStatUI(); // 상단 총 수치 갱신
}

// 전체 초기화
function resetAllEngravings() {
  if (!confirm("정말 모든 슬롯의 각인을 초기화할까요?")) return;

  for (let i = 0; i < slotStates.length; i++) {
    slotStates[i] = { flat: null };
    updateSlotDisplay(i);
  }

  updateLog("🧼 모든 슬롯이 초기화되었습니다.");
  updateTotalStatUI();
}

// 선택 슬롯 초기화
function resetSelectedEngraving() {
  if (selectedSlot === null) return updateLog("먼저 초기화할 슬롯을 선택하세요.");
  if (!confirm(`${slotNames[selectedSlot]} 슬롯을 초기화할까요?`)) return;

  slotStates[selectedSlot] = { flat: null };
  updateSlotDisplay(selectedSlot);
  updateLog(`🧹 ${slotNames[selectedSlot]} 슬롯이 초기화되었습니다.`);
  updateTotalStatUI();
}



document.addEventListener('DOMContentLoaded', () => {
  renderStatTabs();     // 탭 생성
  renderFlatButtons();  // 버튼 생성
  switchTab('flat');
  updateUsageSummary();
  updateGoldUI();
  updateTotalStatUI();
  document.querySelectorAll('#priceConfig input').forEach(input => formatWithComma(input));
});


</script>
</body>
</html>
